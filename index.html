<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Risk Advisory</title>
        <meta name=viewport content="width=device-width initial-scale=1">
        <link href="http://cartodb.com/favicon.ico" rel="shortcut icon" />

        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
    </head>
    <body>
        <div style="height: 700px" id="map"></div>

        <script>
            var kpi_selector_html = function (kpis, title) {
                kpis_html = "";
                kpis_count = 0;
                for (var column in kpis) {
                    kpis_html += '<li><a id="' + column + '" class="layer" href="#">' + kpis[column] + '</a><a href="#" class="kpi right ' + (kpis_count === 0 ? 'enabled' : 'disabled') + ' switch"><span class="handle"></span></a></li>';
                    kpis_count++;
                }
                return '<div class="cartodb-layer-selector-box" style="display: block;"><a href="#" class="layers kpis">' + title + '<div class="count">' + kpis_count + '</div></a><div class="cartodb-dropdown border" style="width: 160px; top: 35px; left: -16.9999px;"><ul>' + kpis_html + '</ul><div class="tail"><span class="border"></span></div></div></div>';
            };

            var city_kpis = {
                city_rating: "City rating",
                security: "Security",
                regime_instabilty: "Regime instability"
            };

            var country_kpis = {
                country_rating: "Country rating",
                security: "Security",
                regime_instabilty: "Regime instability"
            };

            var vizJson = "https://riskadvisory.carto.com/user/riskadvisory-admin/api/v2/viz/4ff3957e-e3eb-11e6-999f-0e3ebc282e83/viz.json";
            cartodb.createVis("map", vizJson, {shareable: false, legends: false})
            .done(function(vis, layers) {
                $(".cartodb-map-wrapper").prepend(kpi_selector_html(city_kpis, "City ratings"));
                $(".cartodb-map-wrapper").prepend(kpi_selector_html(country_kpis, "Country ratings"));
                $(".cartodb-map-wrapper").append('<div class="cartodb-legend-stack" style="display: block;"><div class="cartodb-legend category" style="display: block;"><div class="legend-title">Colors</div><ul><li><div class="bullet" style="background: #A6CEE3"></div> CRITICAL</li><li><div class="bullet" style="background: #1F78B4"></div> IMPORTANT</li><li><div class="bullet" style="background: #B2DF8A"></div> INTERESTING</li><li><div class="bullet" style="background: #33A02C"></div> WARNING</li><li><div class="bullet" style="background: #FB9A99"></div> INFO</li><li><div class="bullet" style="background: #E31A1C"></div> NOTHING</li></ul></div></div>');

                $(".kpis").click(function () {
                    event.stopPropagation();
                    event.preventDefault();
                    $(this).parent().children(".cartodb-dropdown").toggle();
                });
                $(".kpi").click(function (event) {
                    event.stopPropagation();
                    event.preventDefault();
                    $(this).removeClass("disabled");
                    $(this).addClass("enabled");
                    $(this).parent().parent().find('.kpi').not(this).each(function () {
                        $(this).removeClass("enabled");
                        $(this).addClass("disabled");
                    });
                });
            });
        </script>
    </body>
</html>
